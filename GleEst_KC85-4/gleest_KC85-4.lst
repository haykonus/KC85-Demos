 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 1 - 12/8/2024 11:36:47


       1/       0 :                     ;------------------------------------------------------------------------------
       2/       0 :                     ; Titel:                GleEst für KC85/4
       3/       0 :                     ;
       4/       0 :                     ; Erstellt:             20.11.2024
       5/       0 :                     ; Letzte Änderung:      04.12.2024
       6/       0 :                     ;------------------------------------------------------------------------------ 
       7/       0 :                     
       8/       0 :                             cpu     z80
       9/       0 :                     
      10/       0 :                     hi      function x,(x>>8)&255
      11/       0 :                     lo      function x, x&255
      12/       0 :                     
      13/       0 : =8000H               VRAM_START      equ     08000h
      14/       0 : =0A7FFH              VRAM_END        equ     0A7FFh
      15/       0 :                     
      16/       0 : =>DEFINED                    ifndef  BASE
      17/       0 :                                     BASE:   set     0200H   
      18/       0 : [16]                         endif   
      19/     200 :                                     org     BASE
      20/     200 :                             
      21/     200 : 7F 7F 47 4C 45 45           db      7Fh,7Fh, 'GLEEST', 1
              206 : 53 54 01          
      22/     209 :                             
      23/     209 :                     start:  
      24/     209 : CD 00 03                    call    cls
      25/     20C : CD 58 03                    call    initGleEst
      26/     20F :                             
      27/     20F :                     ;------------------------------------------------------------------------------
      28/     20F :                             
      29/     20F :                             ; Start GleEst
      30/     20F :                     
      31/     20F : 31 00 0F            	ld	sp, stack
      32/     212 : 21 01 00                    ld      hl, 0001h       ; (stack) darf nicht 0 sein
      33/     215 : E5                  	push	hl
      34/     216 :                     	
      35/     216 : 21 00 04                    ld      hl, buffer1
      36/     219 :                        
      37/     219 : D9                          exx
      38/     21A :                     
      39/     21A :                             loop_ix:
      40/     21A :                     	
      41/     21A :                     		; TIPP von Crawler
      42/     21A : DD CB 08 46         		bit     0,(ix+8)	 ; Tastenstatusabfrage
      43/     21E : C2 00 E0                            jp      nz, 0E000h
      44/     221 :                             
      45/     221 :                                     ;CALL    0F003H          ; Programmverteiler PV1
      46/     221 :                                     ;db      0Ch             ; KBDS Tastenstatusabfrage 
      47/     221 :                                     ;jp      c,0E000h        ; Reset
      48/     221 :                     
      49/     221 : 21 00 05                            ld      hl,buffer2
      50/     224 :                                     loop:   
      51/     224 :                                             ;ld     bc,10FFh        ; nur wenige Punkte (für Test)
      52/     224 : 01 06 3F                                    ld      bc,3F06h        ; BH = Abstand Punkte, BL = Anzahl Punkte 
      53/     227 :                                             
      54/     227 :                                             d_loop:
      55/     227 :                                                     ;
      56/     227 :                                                     ; Pixel löschen
      57/     227 :                                                     ;
      58/     227 :                                                     
      59/     227 : 5E                                                  ld      e,(hl)          ;BWS lo holen
 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 2 - 12/8/2024 11:36:47


      60/     228 : 23                                                  inc     hl
      61/     229 :                                                     
      62/     229 : 56                                                  ld      d,(hl)          ;BWS hi holen
      63/     22A : 23                                                  inc     hl
      64/     22B :                                                                                                        
      65/     22B : 1A                                                  ld      a,(de)          ;BWS-Byte holen (t)     
      66/     22C : A6                                                  and     (hl)            ;mit BWS-Byte (t-1) kombinieren (Bits löschen)                                               
      67/     22D : 12                                                  ld      (de),a          ;BWS schreiben 
      68/     22E :                                                     
      69/     22E : D9                                                  exx                     
      70/     22F :                                                     
      71/     22F : 7D                                                  proc:   ld      a,L
      72/     230 :                                                     
      73/     230 : 5E                                                          ld      e,(hl)   
      74/     231 : 2C                                                          inc     l
      75/     232 :                                                             
      76/     232 : 56                                                          ld      d,(hl) 
      77/     233 : 2C                                                          inc     l
      78/     234 :                                                             
      79/     234 : 2C                                                          inc     l
      80/     235 : 2C                                                          inc     l
      81/     236 :                                                             
      82/     236 : 4E                                                          ld      c,(hl)  
      83/     237 : 2C                                                          inc     l
      84/     238 :                                                             
      85/     238 : 46                                                          ld      b,(hl)
      86/     239 : EB                                                          ex      de,hl
      87/     23A : 09                                                          add     hl,bc
      88/     23B : EB                                                          ex      de,hl
      89/     23C : CB 3A                                                       srl     d
      90/     23E : CB 1B                                                       rr      e
      91/     240 : 6F                                                          ld      L,a
      92/     241 :                                                             
      93/     241 : 73                                                          ld      (hl),e
      94/     242 : 2C                                                          inc     l
      95/     243 :                                                             
      96/     243 : 72                                                          ld      (hl),d
      97/     244 : 2C                                                          inc     l
      98/     245 :                                                             
      99/     245 : D5                                                          push    de
     100/     246 : E6 02                                                       and     2       
     101/     248 :                                                             
     102/     248 : 28 E5                                               jr      z, proc
     103/     24A :                     
     104/     24A : C1                                                  pop     bc
     105/     24B : E3                                                  ex      (sp),hl         ;hl = (sp)
     106/     24C :                                                     
     107/     24C : D9                                                  exx
     108/     24D :                                                     
     109/     24D : 78                                                  ld      a,b     
     110/     24E :                                                     
     111/     24E : D9                                                  exx                     ;hl = (sp)
     112/     24F :                                                     
     113/     24F : FE 10                                               cp      10h
     114/     251 : 38 40                                               jr      c,dontplot
     115/     253 :                                                     
     116/     253 : 01 40 FD                                            ld      bc,0fd40h
     117/     256 : 09                                                  add     hl,bc
     118/     257 : CB 3C                                               srl     h
     119/     259 : 20 38                                               jr      nz,dontplot
 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 3 - 12/8/2024 11:36:47


     120/     25B :                                                     
     121/     25B : CB 1D                                               rr      l
     122/     25D : 4D                                                  ld      c,L
     123/     25E : 7A                                                  ld      a,d
     124/     25F : 80                                                  add     a,b
     125/     260 : CB 3F                                               srl     a
     126/     262 : 20 2F                                               jr      nz,dontplot
     127/     264 :                                                     
     128/     264 :                                             plot:
     129/     264 : 7B                                                  ld      a,e
     130/     265 : 1F                                                  rra
     131/     266 :                                                     ;cp      0ffh            ; Y max  
     132/     266 :                                                                              
     133/     266 :                                                     ;
     134/     266 :                                                     ; Pixel schreiben
     135/     266 :                                                     ;
     136/     266 :                                                     
     137/     266 :                                                     ;-------------------------------
     138/     266 :                                                     ; ZX Spectrum 
     139/     266 :                                                     ;-------------------------------                                
     140/     266 :                     
     141/     266 :                                                     ; THE 'PIXEL ADDRESS' SUBROUTINE (22AAh)
     142/     266 :                                                     ; This subroutine is called by the POINT subroutine and by the PLOT command routine. 
     143/     266 :                                                     ; Is is entered with the co-ordinates of a pixel in the BC register pair and returns 
     144/     266 :                                                     ; with HL holding the address of the display file byte which contains that pixel 
     145/     266 :                                                     ; and A pointing to the position of the pixel within the byte.
     146/     266 :                                     
     147/     266 :                                                     ;call   c,22b0h         -> Spectrum ROM       in: co-ordinates of a pixel in the AC
     148/     266 :                                                     
     149/     266 :                                                     ;-------------------------------
     150/     266 :                                                     ; KC85/4
     151/     266 :                                                     ;-------------------------------                                
     152/     266 :                                                     
     153/     266 :                                                     ; XPY_to_VRAM
     154/     266 :                                                     ; in:  AC = Y,X 
     155/     266 :                                                     ; out: HL = VRAM, A = Bitpos (3-Bit binär)
     156/     266 :                                                     
     157/     266 :                                                     ;call    c,XPY_to_VRAM  ; nur bei Abfrage von Y-max notwendig
     158/     266 : CD 48 03                                            call    XPY_to_VRAM 
     159/     269 :                     				
     160/     269 : 06 02                                               ld      b,hi(sprite-1)          
     161/     26B : 2F                                                  cpl
     162/     26C : 4F                                                  ld      c,a             
     163/     26D : 0A                                                  ld      a,(bc)          ; BWS-Byte holen
     164/     26E : B6                                                  or      (hl)            ; Hintergrund und Pixel 
     165/     26F : 77                                                  ld      (hl),a          ; BWS-Byte neu schreiben
     166/     270 : 2F                                                  cpl
     167/     271 :                                                     
     168/     271 : E5                                                  push    hl
     169/     272 :                                                     
     170/     272 : D9                                                  exx
     171/     273 :                                                     
     172/     273 : D1                                                  pop     de                         
     173/     274 :                                        
     174/     274 : 77                                                  ld      (hl),a          ; BWS-Byte merken
     175/     275 : 2B                                                  dec     hl
     176/     276 :                                                                                             
     177/     276 : 72                                                  ld      (hl),d          ; BWS hi merken
     178/     277 : 2B                                                  dec     hl
     179/     278 :                                                     
 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 4 - 12/8/2024 11:36:47


     180/     278 : 73                                                  ld      (hl),e          ; BWS lo merken
     181/     279 : 23                                                  inc     hl                      
     182/     27A : 23                                                  inc     hl              
     183/     27B : 78                                                  ld      a,b
     184/     27C :                                                     
     185/     27C : D9                                                  exx
     186/     27D :                                                     
     187/     27D : 0F                                                  rrca    
     188/     27E : 0F                                                  rrca    
     189/     27F : 0F                                                  rrca
     190/     280 : F6 F0                                               or      11110000b
     191/     282 :                                                     
     192/     282 : 4F                                                  ld      c,a
     193/     283 :                     
     194/     283 :                                                     ;
     195/     283 :                                                     ; Farb-Attribut setzen
     196/     283 :                                                     ;
     197/     283 :                                                     
     198/     283 :                                                     ;-------------------------------
     199/     283 :                                                     ; ZX Spectrum 
     200/     283 :                                                     ;-------------------------------
     201/     283 :                                                     
     202/     283 :                                                     ;ld     a,(bc)                  A = Farb-Attribut
     203/     283 :                                                     
     204/     283 :                                                     ; Paper-Attribute ZX-Spectrum
     205/     283 :                                                     ;
     206/     283 :                                                     ; 7  6  5  4  3   2  1  0       Bit
     207/     283 :                                                     ;       G  R  B   G  R  B       Color   G=green, R=red, B=blue  
     208/     283 :                                                     ; F  H  P2 P1 P0  I2 I1 I0      Function
     209/     283 :                     
     210/     283 :                                                     ; Where:
     211/     283 :                     
     212/     283 :                                                     ; F sets the attribute FLASH mode
     213/     283 :                                                     ; H sets the attribute BRIGHTNESS mode
     214/     283 :                                                     ; P2 to P0 is the PAPER colour
     215/     283 :                                                     ; I2 to I0 is the INK colour
     216/     283 :                     
     217/     283 :                                                     ;ld     (23695),a       ; ATTR_T = 5C8Fh ; aktuelle Farben temporaer
     218/     283 :                                                     
     219/     283 :                                                     
     220/     283 :                                                     ; THE 'SET ATTRIBUTE BYTE' SUBROUTINE
     221/     283 :                                                     ; The appropriate attribute byte is identified and fetched. 
     222/     283 :                                                     ; The new value is formed by manipulating the old value, ATTR-T, MASK-T and
     223/     283 :                                                     ; P-FLAG. Finally this new value is copied to the attribute area.
     224/     283 :                                                     
     225/     283 :                                                     ;call   0BDBh   -> Spectrum ROM
     226/     283 :                                                     
     227/     283 :                                                     ;-------------------------------
     228/     283 :                                                     ; KC85/4
     229/     283 :                                                     ;-------------------------------
     230/     283 :                                                     
     231/     283 :                                                     ; 7  6  5  4  3    2  1  0      Bit
     232/     283 :                                                     ;    H  G  R  B    G  R  B      Farbe 
     233/     283 :                                                     ; F  I3 I2 I1 I0   P2 P1 P0     Funktion        
     234/     283 :                                                     
     235/     283 :                                                     ; F=blinken
     236/     283 :                                                     ; H=hell, G=grün, R=rot, B=blau
     237/     283 :                                                     ; P2-P0 = Hintergrundfarbe 
     238/     283 :                                                     ; I3-I0 = Vordergrundfarbe
     239/     283 :                     
 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 5 - 12/8/2024 11:36:47


     240/     283 : DD 7E 01                                            ld      a, (IX+1)        
     241/     286 : F6 02                                               or      a, 00000010b    ; Farbebene ein
     242/     288 :                                                     ;ld      a, 00001010b   ; Anzeige Bild0, Farbebene ein, Zugriff auf Bild0, LowRes, RAM8-Block0   
     243/     288 : D3 84                                               out     (84h), a
     244/     28A :                     
     245/     28A : 0A                                                  ld      a, (bc)         ; Farb-Attribut aus Palette holen
     246/     28B : 77                                                  ld      (HL), a         ; in Farbebene schreiben
     247/     28C :                     
     248/     28C : DD 7E 01                                            ld      a, (IX+1)               
     249/     28F : E6 FD                                               and     a, 11111101b    ; Pixelebene ein
     250/     291 :                                                     ;ld      a, 00001000b   ; Anzeige Bild0, Pixelebene ein, Zugriff auf Bild0, LowRes, RAM8-Block0                  
     251/     291 : D3 84                                               out     (84h), a
     252/     293 :                                                                                               
     253/     293 :                                             dontplot:
     254/     293 : E1                                                  pop     hl              
     255/     294 :                                                     
     256/     294 : D9                                                  exx
     257/     295 :                                                     
     258/     295 : 23                                                  inc     hl              
     259/     296 :                     
     260/     296 : 10 8F                                       djnz    d_loop
     261/     298 :                     
     262/     298 : 09                                          add     hl,bc   
     263/     299 :                                             
     264/     299 : D9                                          exx                     
     265/     29A :                                             
     266/     29A :                                             random:
     267/     29A : D1                                                  pop     de
     268/     29B : 06 10                                               ld      b,10h
     269/     29D :                                                     
     270/     29D : CB 23                                               backw:  sla     e
     271/     29F : CB 12                                                       rl      d
     272/     2A1 : 7A                                                          ld      a,d
     273/     2A2 : E6 C0                                                       and     0c0h    
     274/     2A4 : EA A8 02                                                    jp      pe,forw
     275/     2A7 : 1C                                                          inc     e
     276/     2A8 :                                                             
     277/     2A8 : 10 F3                                       forw:   djnz    backw
     278/     2AA :                                             
     279/     2AA : 7A                                                  ld      a,d
     280/     2AB : D5                                                  push    de
     281/     2AC : 1F                                                  rra
     282/     2AD : CB 18                                               rr      b
     283/     2AF : E6 07                                               and     07h
     284/     2B1 : 70                                                  ld      (hl),b   
     285/     2B2 : 2C                                                  inc     l
     286/     2B3 : 77                                                  ld      (hl),a  
     287/     2B4 : 2C                                                  inc     l
     288/     2B5 : 20 E3                                       jr      nz,random
     289/     2B7 :                                             
     290/     2B7 : D9                                          exx                             
     291/     2B8 :                                             
     292/     2B8 : 3E 0E                                       ld      a,hi(buffer2_end)
     293/     2BA : BC                                          cp      a,h
     294/     2BB :                                             
     295/     2BB : C2 24 02                            jp      nz,loop
     296/     2BE :                                     
     297/     2BE : C3 1A 02                    jp      loop_ix
     298/     2C1 :                             
     299/     2C1 :                     ;------------------------------------------------------------------------------
 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 6 - 12/8/2024 11:36:47


     300/     2C1 :                     
     301/     2F2 :                             org     BASE+0F8h-6
     302/     2F2 :                     
     303/     2F2 :                     palette:
     304/     2F2 :                     
     305/     2F2 :                             ; F=blinken
     306/     2F2 :                             ; H=hell, G=grün, R=rot, B=blau
     307/     2F2 :                             ; P2-P0   = Hintergrundfarbe 
     308/     2F2 :                             ; I3/2-I0 = Vordergrundfarbe
     309/     2F2 :                             
     310/     2F2 : =>FALSE                      if 0 = 1
     311/     2F2 :                             ;----------------------------------------
     312/     2F2 :                             ; ZX Spectrum 
     313/     2F2 :                             ;----------------------------------------       
     314/     2F2 :                             ; 7  6  5  4  3   2  1  0       Bit
     315/     2F2 :                             ;       G  R  B   G  R  B       Farbe   
     316/     2F2 :                             ; F  H  P2 P1 P0  I2 I1 I0      Funktion
     317/     2F2 :                                                     
     318/     2F2 :                             db      45h             ; HGB
     319/     2F2 :                                     ;01 000 101
     320/     2F2 :                             
     321/     2F2 :                             db      44h             ; HG
     322/     2F2 :                                     ;01 000 100
     323/     2F2 :                             
     324/     2F2 :                             db      06h             ; GR
     325/     2F2 :                                     ;00 000 110
     326/     2F2 :                             
     327/     2F2 :                             db      42h             ; HR
     328/     2F2 :                                     ;01 000 010
     329/     2F2 :                     
     330/     2F2 :                             db      03h             ; RB
     331/     2F2 :                                     ;00 000 011
     332/     2F2 :                     
     333/     2F2 :                             db      01h             ; B
     334/     2F2 :                                     ;00 000 001
     335/     2F2 : [310]                        endif
     336/     2F2 :                     
     337/     2F2 :                             ;----------------------------------------
     338/     2F2 :                             ; KC85/4
     339/     2F2 :                             ;----------------------------------------
     340/     2F2 :                             ; 7  6  5  4  3    2  1  0      Bit
     341/     2F2 :                             ;    H  G  R  B    G  R  B      Farbe 
     342/     2F2 :                             ; F  I3 I2 I1 I0   P2 P1 P0     Funktion        
     343/     2F2 :                     
     344/     2F2 : 28                          db      00101000b       ; GB
     345/     2F3 : 20                          db      00100000b       ; G  
     346/     2F4 : 30                          db      00110000b       ; GR 
     347/     2F5 : 10                          db      00010000b       ; R  
     348/     2F6 : 18                          db      00011000b       ; RB 
     349/     2F7 : 08                          db      00001000b       ; B  
     350/     2F8 :                     
     351/     2F8 : 01                          db      00000001b
     352/     2F9 : 02                          db      00000010b
     353/     2FA : 04                          db      00000100b
     354/     2FB : 08                          db      00001000b
     355/     2FC : 10                          db      00010000b
     356/     2FD : 20                          db      00100000b
     357/     2FE : 40                          db      01000000b
     358/     2FF : 80                          db      10000000b
     359/     300 :                     sprite:
 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 7 - 12/8/2024 11:36:47


     360/     300 :                     
     361/     300 :                         
     362/     300 :                             
     363/     300 :                     ;------------------------------------------------------------------------------
     364/     300 :                     ; KC85/4 Grafik-Routinen
     365/     300 :                     ;------------------------------------------------------------------------------
     366/     300 :                     
     367/     300 :                     ; KC85/5 Systemhandbuch S.127
     368/     300 :                     
     369/     300 :                     ; Ausgabe Port 84H bzw. (IX + 1)
     370/     300 :                     ; Bit 0 - Anzeige Bild 0 oder 1
     371/     300 :                     ; Bit 1 - Zugriff auf Pixel- oder Farbebene(Pixel = 0 oder Farbe = 1)
     372/     300 :                     ; Bit 2 - Zugriff auf Bild 0 oder 1
     373/     300 :                     ; Bit 3 - hohe Farbauflösung ein/aus(0 = hohe oder 1 = niedrige)
     374/     300 :                     
     375/     300 :                     ; Bit 4 -+
     376/     300 :                     ; Bit 5  +- Auswahl der RAM8-Ebene (4 Bit = 16 Ebenen)
     377/     300 :                     ; Bit 6  |
     378/     300 :                     ; Bit 7 -+
     379/     300 :                     ;
     380/     300 :                     ; Farben s. KC85/5 Systemhandbuch S.232-233
     381/     300 :                     
     382/     300 :                     ;------------------------------------------------------------------------------
     383/     300 :                     ; Löscht Pixel/Farb-RAM0
     384/     300 :                     ;------------------------------------------------------------------------------
     385/     300 :                     
     386/     300 :                     cls:
     387/     300 : 21 00 80                    ld      hl, VRAM_START
     388/     303 : AF                          xor     a                       ; alle Pixel aus
     389/     304 : 77                          ld      (hl), a 
     390/     305 : 11 01 80                    ld      de, VRAM_START+1
     391/     308 : 01 FF 27                    ld      bc, VRAM_END-VRAM_START
     392/     30B : ED B0                       ldir
     393/     30D :                             
     394/     30D : DD 7E 01                    ld      a, (IX+1)               ; streng nach Vorschrift ...
     395/     310 : F6 02                       or      a, 00000010b            ; Farbebene ein
     396/     312 : DD 77 01                    ld      (IX+1), a               ; streng nach Vorschrift ...
     397/     315 : D3 84                       out     (84h), a
     398/     317 :                     
     399/     317 : 21 00 80                    ld      hl, VRAM_START
     400/     31A : AF                          xor     a                       ; alle Farben aus
     401/     31B : 77                          ld      (hl), a
     402/     31C : 11 01 80                    ld      de, VRAM_START+1
     403/     31F : 01 FF 27                    ld      bc, VRAM_END-VRAM_START
     404/     322 : ED B0                       ldir
     405/     324 :                     
     406/     324 : DD 7E 01                    ld      a, (IX+1)               ; streng nach Vorschrift ...
     407/     327 : E6 FD                       and     a, 11111101b            ; Pixelebene ein
     408/     329 : DD 77 01                    ld      (IX+1), a               ; streng nach Vorschrift ...    
     409/     32C : D3 84                       out     (84h), a
     410/     32E :                             
     411/     32E : C9                          ret
     412/     32F :                             
     413/     32F :                     ;------------------------------------------------------------------------------
     414/     32F :                     ; in:  AC = Y,X (Pixelzeile, Pixelspalte)
     415/     32F :                     ; out: HL = VRAM, A = Bitpos (3 Bit binär)
     416/     32F :                     ;------------------------------------------------------------------------------
     417/     32F :                     
     418/     32F :                     XPY_to_VRAM_old:
     419/     32F :                     
 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 8 - 12/8/2024 11:36:47


     420/     32F : 47                          ld      b, a            
     421/     330 : 79                          ld      a, c
     422/     331 : E6 07                       and     a, 00000111b    ; Bitpos (0-7)
     423/     333 : F5                          push    af              ; Bitpos merken
     424/     334 :                             
     425/     334 :                             ; Pixelspalte / 8 = Zeichenspalte
     426/     334 :                             
     427/     334 : CB 39                       srl     c
     428/     336 : CB 39                       srl     c
     429/     338 : CB 39                       srl     c
     430/     33A :                             
     431/     33A :                             ; aus KC85/5 System-Handbuch S.231
     432/     33A :                             
     433/     33A :                             ; Adresse = 8000H + Zeichenspalte * 100H + Pixelzeile
     434/     33A :                             ; 0 =< Zeichenspalte =< 27H
     435/     33A :                             ; 0 =< Pixelzeile =< 0FFH
     436/     33A :                             
     437/     33A : 78                          ld      a, b                    ; a=Pixelzeile merken
     438/     33B : 41                          ld      b, c                    ; b=Zeichenspalte * 100H
     439/     33C : 0E 00                       ld      c, 0
     440/     33E : 21 00 84                    ld      hl, VRAM_START+4*256    ; Start + Bild mittig
     441/     341 : 09                          add     hl, bc                  ; 8000H + Zeichenspalte * 100H
     442/     342 : 06 00                       ld      b, 0
     443/     344 : 4F                          ld      c, a
     444/     345 : 09                          add     hl, bc                  ; (8000H + Zeichenspalte * 100H) + Pixelzeile
     445/     346 : F1                          pop     af      
     446/     347 : C9                          ret
     447/     348 :                     
     448/     348 :                     ;------------------------------------------------------------------------------
     449/     348 :                     ; in:  AC = Y,X (Pixelzeile, Pixelspalte)
     450/     348 :                     ; out: HL = VRAM, A = Bitpos (3 Bit binär)
     451/     348 :                     ;
     452/     348 :                     ; TIPP von KaiOr
     453/     348 :                     ;------------------------------------------------------------------------------
     454/     348 :                     
     455/     348 :                     XPY_to_VRAM:
     456/     348 :                             
     457/     348 : 6F                          ld      l, a
     458/     349 :                             
     459/     349 :                             ; Pixelspalte / 8 = Zeichenspalte
     460/     349 :                             
     461/     349 : 79                          ld      a, c
     462/     34A : 1F                          rra
     463/     34B : 1F                          rra
     464/     34C : 1F                          rra
     465/     34D : E6 1F                       and     1Fh             ;Bit 7-5 loeschen
     466/     34F :                             
     467/     34F :                             ; aus KC85/4 System-Handbuch S.112
     468/     34F :                             
     469/     34F :                             ; Adresse = 8000H + Zeichenspalte * 100H + Pixelzeile
     470/     34F :                             ; 0 =< Zeichenspalte =< 27H
     471/     34F :                             ; 0 =< Pixelzeile =< 0FFH
     472/     34F :                             
     473/     34F : F6 80                       or      80h             ;Adressbereich auf obere 8000H heben
     474/     351 : C6 04                       add     a, 4            ;Bild mittig
     475/     353 : 67                          ld      h, a
     476/     354 : 79                          ld      a, c
     477/     355 : E6 07                       and     00000111b       ; Bitpos (0-7)
     478/     357 : C9                          ret
     479/     358 :                             
 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 9 - 12/8/2024 11:36:47


     480/     358 :                     ;------------------------------------------------------------------------------
     481/     358 :                     ; 1. buffer2 wird mit Adresse von "dummy" und 55h initialisiert, damit beim 
     482/     358 :                     ;    Start von GleEst keine undefinierten Schreibvorgänge im RAM erfolgen können.
     483/     358 :                     ;
     484/     358 :                     ; 2. (stack) = 0001h, damit GleEst startet, wegen ex (sp),hl
     485/     358 :                     ;------------------------------------------------------------------------------
     486/     358 :                     
     487/     358 :                     initGleEst:
     488/     358 :                     
     489/     358 : 01 00 03                    ld      bc, (buffer2_end-buffer2)/3
     490/     35B : 21 00 05                    ld      hl, buffer2
     491/     35E : 11 6E 03                    ld      de, dummy
     492/     361 : 73                  fb1:    ld      (hl), e
     493/     362 : 23                          inc     hl
     494/     363 : 72                          ld      (hl), d
     495/     364 : 23                          inc     hl
     496/     365 : 36 55                       ld      (hl), 55h
     497/     367 : 23                          inc     hl
     498/     368 :                             
     499/     368 : 0B                          dec     bc
     500/     369 : 78                          ld      a, b
     501/     36A : B1                          or      c
     502/     36B : 20 F4                       jr      nz, fb1
     503/     36D :                     	
     504/     36D : C9                          ret
     505/     36E :                     
     506/     36E :                     ;------------------------------------------------------------------------------
     507/     36E :                     end
     508/     36E :                                     
     509/     36E :                             ; RAM für GleEst
     510/     36E :                             
     511/     36E : 55                  dummy:  db      55h  
     512/     36F :                        
     513/     36F :                             align   100h     
     514/     400 :                     buffer1:        
     515/     400 :                             ds      100h
     516/     500 :                     buffer2:        
     517/     500 :                             ds      900h
     518/     E00 :                     buffer2_end:  
     519/     E00 :                       
     520/     E00 :                             ds      100h
     521/     F00 :                     stack:  
     522/     F00 :                       
     523/     F00 :                             
     524/     F00 :                     
     525/     F00 :                     
     526/     F00 :                     
     527/     F00 :                     
 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 10 - 12/8/2024 11:36:47


  Symbol Table (* = unused):
  --------------------------

*ARCHITECTURE :                                        "i386-unknown-win32" - |
 BACKW :                        29D C |  BASE :                         200 - |
 BUFFER1 :                      400 C |  BUFFER2 :                      500 C |
 BUFFER2_END :                 0E00 C | *CASESENSITIVE :                  0 - |
 CLS :                          300 C | *CONSTPI :        3.141592653589793 - |
*DATE :                 "12/8/2024" - |  DONTPLOT :                     293 C |
 DUMMY :                        36E C |  D_LOOP :                       227 C |
*END :                          36E C | *FALSE :                          0 - |
 FB1 :                          361 C |  FORW :                         2A8 C |
*FULLPMMU :                       1 - | *HAS64 :                          0 - |
*HASFPU :                         0 - | *HASPMMU :                        0 - |
 INITGLEEST :                   358 C | *INSUPMODE :                      0 - |
*LISTON :                         1 - |  LOOP :                         224 C |
 LOOP_IX :                      21A C | *MACEXP :                         7 - |
*MOMCPU :                        80 - | *MOMCPUNAME :                 "Z80" - |
*NESTMAX :                      100 - | *PADDING :                        1 - |
*PALETTE :                      2F2 C | *PLOT :                         264 C |
 PROC :                         22F C |  RANDOM :                       29A C |
*RELAXED :                        0 - |  SPRITE :                       300 C |
 STACK :                       0F00 C | *START :                        209 C |
*TIME :                  "11:36:47" - | *TRUE :                           1 - |
*VERSION :                     142F - |  VRAM_END :                   0A7FF - |
 VRAM_START :                  8000 - |  XPY_TO_VRAM :                  348 C |
*XPY_TO_VRAM_OLD :              32F C |

     46 symbols
     25 unused symbols

 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 11 - 12/8/2024 11:36:47


  Defined Functions:
  ------------------

LO                                    | HI                                   

 AS V1.42 Beta [Bld 240] - Source File gleest_KC85-4.asm - Page 12 - 12/8/2024 11:36:47


  Code Pages:
  ----------

STANDARD (0 changed characters)

1 code page

0.01 seconds assembly time

    527 lines source file
      2 passes
      0 errors
      0 warnings
